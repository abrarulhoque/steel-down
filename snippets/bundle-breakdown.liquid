{%- liquid
  assign heading = block.settings.heading
  assign layout = block.settings.layout
  assign bundle_products = block.settings.bundle_products
-%}

<div class="bundle-breakdown" id="bundle-breakdown-section" data-layout="{{ layout }}">
  
  {%- if heading != blank -%}
  <div class="bundle-breakdown__header">
    <h3 class="bundle-breakdown__title">{{ heading }}</h3>
    
    {%- if layout == 'cards' or layout == 'grid' -%}
    <div class="layout-toggles">
      <button class="layout-toggle" data-layout="cards" {% if layout == 'cards' %}class="active"{% endif %}>
        <svg width="16" height="16" viewBox="0 0 16 16">
          <rect x="2" y="2" width="5" height="3" rx="1" fill="currentColor"/>
          <rect x="9" y="2" width="5" height="3" rx="1" fill="currentColor"/>
          <rect x="2" y="6" width="5" height="3" rx="1" fill="currentColor"/>
          <rect x="9" y="6" width="5" height="3" rx="1" fill="currentColor"/>
        </svg>
        Cards
      </button>
      <button class="layout-toggle" data-layout="grid" {% if layout == 'grid' %}class="active"{% endif %}>
        <svg width="16" height="16" viewBox="0 0 16 16">
          <rect x="2" y="2" width="3" height="3" rx="0.5" fill="currentColor"/>
          <rect x="6" y="2" width="3" height="3" rx="0.5" fill="currentColor"/>
          <rect x="10" y="2" width="3" height="3" rx="0.5" fill="currentColor"/>
          <rect x="2" y="6" width="3" height="3" rx="0.5" fill="currentColor"/>
          <rect x="6" y="6" width="3" height="3" rx="0.5" fill="currentColor"/>
          <rect x="10" y="6" width="3" height="3" rx="0.5" fill="currentColor"/>
        </svg>
        Grid
      </button>
    </div>
    {%- endif -%}
  </div>
  {%- endif -%}

  <div class="bundle-breakdown__content bundle-breakdown__content--{{ layout }}">
    
    {%- if layout == 'receipt' -%}
      <div class="receipt-list">
        {%- assign total_separate = 0 -%}
        {%- assign total_bundle = 0 -%}
        
        {%- for bundle_product in bundle_products -%}
          {%- assign separate_price = bundle_product.price -%}
          {%- assign bundle_price = bundle_product.price | times: 0.8 -%}
          {%- assign total_separate = total_separate | plus: separate_price -%}
          {%- assign total_bundle = total_bundle | plus: bundle_price -%}
          
          <div class="receipt-item">
            <div class="receipt-item__image">
              {%- if bundle_product.featured_image -%}
                <img src="{{ bundle_product.featured_image | img_url: '60x60' }}" 
                     alt="{{ bundle_product.title }}"
                     width="30" 
                     height="30"
                     loading="lazy">
              {%- endif -%}
            </div>
            <div class="receipt-item__details">
              <span class="item-name">{{ bundle_product.title }}</span>
              {%- if bundle_product.variants.size > 1 -%}
                <span class="item-variant">{{ bundle_product.variants.first.title }}</span>
              {%- endif -%}
            </div>
            <div class="receipt-item__pricing">
              <span class="separate-price">{{ separate_price | money }}</span>
              <span class="bundle-price">{{ bundle_price | money }}</span>
            </div>
          </div>
        {%- endfor -%}
        
        <div class="receipt-totals">
          <div class="receipt-total-line">
            <span class="total-label">If bought separately:</span>
            <span class="total-amount separate">{{ total_separate | money }}</span>
          </div>
          <div class="receipt-total-line discount">
            <span class="total-label">Bundle discount:</span>
            <span class="total-amount discount">-{{ total_separate | minus: total_bundle | money }}</span>
          </div>
          <div class="receipt-total-line final">
            <span class="total-label">Your total:</span>
            <span class="total-amount final">{{ total_bundle | money }}</span>
          </div>
        </div>
      </div>
    
    {%- elsif layout == 'cards' -%}
      <div class="card-stack">
        {%- for bundle_product in bundle_products -%}
          <div class="product-card">
            <div class="product-card__image">
              {%- if bundle_product.featured_image -%}
                <img src="{{ bundle_product.featured_image | img_url: '200x200' }}" 
                     alt="{{ bundle_product.title }}"
                     loading="lazy">
              {%- endif -%}
            </div>
            <div class="product-card__content">
              <h4 class="product-card__title">{{ bundle_product.title }}</h4>
              {%- if bundle_product.description != blank -%}
                <p class="product-card__description">{{ bundle_product.description | truncate: 80 }}</p>
              {%- endif -%}
              
              {%- if bundle_product.variants.size > 1 -%}
                <div class="product-card__variants">
                  {%- for variant in bundle_product.variants limit: 3 -%}
                    <button class="variant-chip">{{ variant.title }}</button>
                  {%- endfor -%}
                </div>
              {%- endif -%}
              
              {%- if bundle_product.tags contains 'bestseller' -%}
                <span class="micro-badge bestseller">Best-seller</span>
              {%- elsif bundle_product.tags contains 'new' -%}
                <span class="micro-badge new">New</span>
              {%- elsif bundle_product.tags contains 'freebie' -%}
                <span class="micro-badge freebie">Freebie</span>
              {%- endif -%}
              
              {%- assign inventory_qty = bundle_product.selected_or_first_available_variant.inventory_quantity -%}
              {%- if inventory_qty > 0 and inventory_qty <= 5 -%}
                <div class="stock-notice">Only {{ inventory_qty }} left</div>
              {%- endif -%}
            </div>
          </div>
        {%- endfor -%}
      </div>
      
    {%- elsif layout == 'grid' -%}
      <div class="compact-grid">
        {%- for bundle_product in bundle_products -%}
          <div class="grid-item">
            <div class="grid-item__image">
              {%- if bundle_product.featured_image -%}
                <img src="{{ bundle_product.featured_image | img_url: '120x120' }}" 
                     alt="{{ bundle_product.title }}"
                     loading="lazy">
              {%- endif -%}
            </div>
            <div class="grid-item__content">
              <h5 class="grid-item__title">{{ bundle_product.title }}</h5>
              <div class="grid-item__price">{{ bundle_product.price | money }}</div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    {%- endif -%}
    
  </div>
</div>

<style>
.bundle-breakdown {
  background: #fff;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
}

.bundle-breakdown__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.bundle-breakdown__title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.layout-toggles {
  display: flex;
  gap: 8px;
}

.layout-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.layout-toggle.active,
.layout-toggle:hover {
  background: #f5f5f5;
  border-color: #999;
}

/* Receipt Style */
.receipt-list {
  background: #fafafa;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 16px;
}

.receipt-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}

.receipt-item:last-child {
  border-bottom: none;
  margin-bottom: 12px;
}

.receipt-item__image img {
  width: 30px;
  height: 30px;
  border-radius: 4px;
  object-fit: cover;
}

.receipt-item__details {
  flex: 1;
}

.item-name {
  display: block;
  font-weight: 500;
  font-size: 14px;
}

.item-variant {
  display: block;
  font-size: 12px;
  color: #666;
}

.receipt-item__pricing {
  text-align: right;
}

.separate-price {
  display: block;
  font-size: 12px;
  color: #999;
  text-decoration: line-through;
}

.bundle-price {
  display: block;
  font-weight: 600;
  color: #c00000;
}

.receipt-totals {
  border-top: 2px solid #ddd;
  padding-top: 12px;
}

.receipt-total-line {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
}

.receipt-total-line.final {
  font-weight: 700;
  font-size: 16px;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #ddd;
}

.total-amount.discount {
  color: #c00000;
}

/* Card Stack Style */
.card-stack {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.product-card {
  display: flex;
  gap: 16px;
  padding: 16px;
  border: 1px solid #eee;
  border-radius: 8px;
  background: #fff;
}

.product-card__image {
  flex-shrink: 0;
  width: 80px;
  height: 80px;
}

.product-card__image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
}

.product-card__content {
  flex: 1;
  position: relative;
}

.product-card__title {
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 8px 0;
}

.product-card__description {
  font-size: 14px;
  color: #666;
  margin: 0 0 12px 0;
  line-height: 1.4;
}

.product-card__variants {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
}

.variant-chip {
  padding: 4px 8px;
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.variant-chip:hover,
.variant-chip.selected {
  background: #333;
  color: #fff;
}

.micro-badge {
  position: absolute;
  top: 0;
  right: 0;
  padding: 2px 6px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  border-radius: 10px;
}

.micro-badge.bestseller {
  background: #ff6b35;
  color: white;
}

.micro-badge.new {
  background: #4caf50;
  color: white;
}

.micro-badge.freebie {
  background: #2196f3;
  color: white;
}

.stock-notice {
  font-size: 12px;
  color: #ff6b35;
  font-weight: 500;
  margin-top: 8px;
}

/* Compact Grid Style */
.compact-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 16px;
}

.grid-item {
  text-align: center;
}

.grid-item__image {
  margin-bottom: 8px;
}

.grid-item__image img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
}

.grid-item__title {
  font-size: 14px;
  font-weight: 500;
  margin: 0 0 4px 0;
}

.grid-item__price {
  font-size: 12px;
  color: #666;
}

@media (max-width: 768px) {
  .bundle-breakdown {
    padding: 16px;
  }
  
  .layout-toggles {
    display: none;
  }
  
  .compact-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .product-card {
    flex-direction: column;
    text-align: center;
  }
  
  .product-card__image {
    align-self: center;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggles = document.querySelectorAll('.layout-toggle');
  const content = document.querySelector('.bundle-breakdown__content');
  
  toggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const layout = this.dataset.layout;
      
      // Update active state
      toggles.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Update content layout
      content.className = `bundle-breakdown__content bundle-breakdown__content--${layout}`;
      
      // Update container data attribute
      document.querySelector('.bundle-breakdown').dataset.layout = layout;
    });
  });
});
</script>